# GLPI Helpdesk System
# Deploy with: docker compose up -d
# Domain: helpdesk.bluemoonit.com.au

services:
  glpi:
    image: diouxx/glpi:latest
    container_name: glpi
    restart: unless-stopped
    environment:
      # Timezone
      - TIMEZONE=Australia/Sydney

      # Database Configuration (for auto-setup or reference)
      - MARIADB_HOST=mariadb
      - MARIADB_PORT=3306
      - MARIADB_DATABASE=${DB_NAME}
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
      - RESEND_API_KEY=${RESEND_API_KEY}

    volumes:
      # Custom portal page (landing page for users)
      - ./portal.php:/var/www/html/glpi/portal.php:ro
      - ./.htaccess:/var/www/html/glpi/.htaccess:ro

      # Persist GLPI data
      - glpi_data:/var/www/html/glpi
      - glpi_config:/var/www/html/glpi/config
      - glpi_files:/var/www/html/glpi/files
      - glpi_plugins:/var/www/html/glpi/plugins
      - glpi_marketplace:/var/www/html/glpi/marketplace

    networks:
      - proxy
      - backend

    labels:
      - "traefik.enable=true"

      # HTTP Router - Redirect to HTTPS
      - "traefik.http.routers.glpi-http.rule=Host(`helpdesk.bluemoonit.com.au`)"
      - "traefik.http.routers.glpi-http.entrypoints=http"
      - "traefik.http.routers.glpi-http.middlewares=glpi-redirect"
      - "traefik.http.middlewares.glpi-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.glpi-redirect.redirectscheme.permanent=true"

      # HTTPS Router
      - "traefik.http.routers.glpi.rule=Host(`helpdesk.bluemoonit.com.au`)"
      - "traefik.http.routers.glpi.entrypoints=https"
      - "traefik.http.routers.glpi.tls=true"
      - "traefik.http.routers.glpi.tls.certresolver=letsencrypt"

      # Service - GLPI runs on port 80 internally
      - "traefik.http.services.glpi.loadbalancer.server.port=80"

      # Security Headers
      - "traefik.http.routers.glpi.middlewares=glpi-headers"
      - "traefik.http.middlewares.glpi-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.glpi-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.glpi-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.glpi-headers.headers.forceSTSHeader=true"

  mariadb:
    image: mariadb:10.11
    container_name: mariadb
    restart: unless-stopped
    command: --default-time-zone='+11:00'
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - TZ=Australia/Sydney
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - backend

volumes:
  glpi_data:
    driver: local
  glpi_config:
    driver: local
  glpi_files:
    driver: local
  glpi_plugins:
    driver: local
  glpi_marketplace:
    driver: local
  mariadb_data:
    driver: local

networks:
  proxy:
    external: true
  backend:
    external: true
